<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SillyTavern Worldbook Generator</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(to right, #f0f2f5, #c9d6ff);
      margin: 0;
      padding: 20px;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 40px;
      text-align: center;
    }

    h1 {
      color: #2c3e50;
      font-size: 2.5em;
      margin-bottom: 20px;
    }

    .card {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-top: 20px;
      text-align: left;
    }

    .card h2 {
      color: #3498db;
      margin-top: 0;
      font-size: 1.5em;
      margin-bottom: 15px;
    }

    .card ol,
    .card ul {
      padding-left: 20px;
      margin-bottom: 15px;
    }

    .card ol li,
    .card ul li {
      margin-bottom: 8px;
      line-height: 1.6;
      font-size: 1.05em;
    }

    .button {
      background: #3498db;
      color: #ffffff;
      border: none;
      padding: 15px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.2em;
      transition: background 0.3s;
      margin: 20px 0;
      display: inline-block;
    }

    .button:hover {
      background: #2980b9;
    }

    .file-input {
      display: inline-block;
      margin: 20px auto;
      font-size: 1.2em;
    }

    #output {
      white-space: pre-wrap;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: left;
      max-height: 400px;
      overflow-y: auto;
    }

    a.download-link {
      display: block;
      text-align: center;
      color: #3498db;
      text-decoration: none;
      margin-top: 20px;
      font-weight: bold;
    }

    a.download-link:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>SillyTavern Worldbook Generator</h1>
    <div class="card">
      <h2>ä½¿ç”¨æ–¹æ³•:</h2>
      <ol>
        <li>ç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶å¤¹â€æŒ‰é’®ï¼Œé€‰æ‹©è¦ç”Ÿæˆ Worldbook çš„æ–‡ä»¶å¤¹ã€‚</li>
        <li>ç‚¹å‡»â€œç”Ÿæˆ Worldbookâ€æŒ‰é’®ã€‚</li>
        <li>åœ¨é¡µé¢åº•éƒ¨å°†ç”Ÿæˆå¹¶æ˜¾ç¤ºä¸€ä¸ªä¸‹è½½é“¾æ¥ï¼Œç‚¹å‡»ä¸‹è½½ç”Ÿæˆçš„ worldbook.json æ–‡ä»¶ã€‚</li>
      </ol>
      <h2>æ³¨æ„äº‹é¡¹:</h2>
      <ul>
        <li>å¤–å±‚æ–‡ä»¶å¤¹åå³ä¸ºé€‰ä¸­çš„æ–‡ä»¶å¤¹ï¼Œä¼šç”¨äºä¸–ç•Œä¹¦æ–‡ä»¶å‘½åï¼Œå¹¶ä¼šæ·»åŠ è‡³ç¬¬ä¸€ä¸ªå¸¸é©»æ¡ç›®ä¸­ã€‚</li>
        <li>ç¬¬ä¸€ä¸ªæ¡ç›®åŒ…å«ä¸–ç•Œä¹¦çš„ç”Ÿæˆæ—¶é—´ï¼Œé…ç½®ä¿¡æ¯ï¼Œå…è´£å£°æ˜ï¼Œç‰ˆæƒå£°æ˜ï¼Œå’Œä½œè€…ç­‰ä¿¡æ¯ï¼Œè¯·æ ¹æ®éœ€è¦è‡ªè¡Œå¡«å†™ã€‚</li>
        <li>æ¯ä¸ªæ–‡ä»¶å¤¹çš„å¼€å§‹å’Œç»“æŸéƒ½ä¼šè‡ªåŠ¨æ·»åŠ åˆ†å‰²çº¿æ¡ç›®ï¼Œå¸®åŠ©æ¨¡å—åŒ–ç®¡ç†ã€‚</li>
        <li>å†…éƒ¨æ¡ç›®å°†ä¸è§¦å‘é€’å½’æ‰«æã€‚</li>
        <li>ä¼šç›´æ¥è¯»å–æ–‡ä»¶å¤¹å†…æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬ txt, yaml ç­‰ï¼‰å†…å®¹ã€‚</li>
      </ul>
      <h2>åŠŸèƒ½è¯´æ˜:</h2>
      <ul>
        <li>**æ–‡ä»¶å¤¹åå°†ä½œä¸ºæ¡ç›®çš„ä¸»è¦å…³é”®è¯ï¼ˆ`key`ï¼‰ï¼Œç”¨äºè§¦å‘å¯¹åº”æ¡ç›®ã€‚**</li>
        <li>**æ–‡ä»¶åå°†ä½œä¸ºæ¡ç›®çš„æ¬¡è¦å…³é”®è¯ï¼ˆ`keysecondary`ï¼‰ï¼Œç”¨äºç²¾ç¡®åŒ¹é…ã€‚**</li>
        <li>ä¼šæ ¹æ®æ–‡ä»¶å¤§å°å¾®è°ƒæ¡ç›®æ·±åº¦(`depth`):
          <ul>
            <li>å°äºç­‰äº 512 å­—èŠ‚ï¼š `depth` ä¸º 4</li>
            <li>å°äºç­‰äº 1024 å­—èŠ‚ï¼š`depth` ä¸º 5</li>
            <li>å°äºç­‰äº 1536 å­—èŠ‚ï¼š`depth` ä¸º 6</li>
            <li>å°äºç­‰äº 2048 å­—èŠ‚ï¼š`depth` ä¸º 7</li>
            <li>å¤§äº 2048 å­—èŠ‚ï¼š`depth` ä¸º 8</li>
          </ul>
        </li>
      </ul>
    </div>

    <input type="file" id="fileInput" class="file-input" webkitdirectory>

    <button class="button" onclick="generateWorldbook()">ç”Ÿæˆ Worldbook</button>

    <div id="output"></div>
  </div>

  <script>
    /**
      * åˆ›å»ºä¸€ä¸ªä¸–ç•Œä¹¦æ¡ç›®
      * @param {object} info - æ¡ç›®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ uid, key, keysecondary, comment, content, displayIndex
      * @param {number} order - æ’å…¥é¡ºåº
      * @param {number} depth - æ·±åº¦
      * @returns {object} - ä¸–ç•Œä¹¦æ¡ç›®å¯¹è±¡
      * 
      *  ä»¥ä¸‹æ˜¯å¯¹åº”ç»“æ„ç»Ÿä¸€è¯´æ˜
      *  uid: "å”¯ä¸€ IDï¼Œæ•´æ•°ç±»å‹"
      *  key: "è§¦å‘æ¡ç›®çš„å…³é”®å­—åˆ—è¡¨ï¼Œæ”¯æŒæ–‡æœ¬å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œå­—ç¬¦ä¸²æ•°ç»„"
      *  keysecondary: "å¯é€‰çš„æ¬¡è¦å…³é”®å­—åˆ—è¡¨ï¼Œå­—ç¬¦ä¸²æ•°ç»„"
      *  comment: "æ¡ç›®çš„æ³¨é‡Šæˆ–æ ‡é¢˜ï¼Œå­—ç¬¦ä¸²ç±»å‹"
      *  content: "æ’å…¥åˆ°æç¤ºè¯çš„æ–‡æœ¬å†…å®¹ï¼Œå­—ç¬¦ä¸²ç±»å‹"
      *  constant: "æ˜¯å¦å¸¸é©»ï¼Œå¦‚æœä¸º true åˆ™å§‹ç»ˆæ’å…¥ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
      *  vectorized: "æ˜¯å¦ä»…é€šè¿‡å‘é‡åŒ¹é…æ¿€æ´»ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
      *  selective: "æ˜¯å¦å¯ç”¨é€‰æ‹©æ€§è¿‡æ»¤,éœ€è¦åŒæ—¶æ»¡è¶³ key å’Œ keysecondary æ‰èƒ½è§¦å‘ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
      *  selectiveLogic: "é€‰æ‹©æ€§é€»è¾‘ï¼Œæ•´æ•°ç±»å‹ï¼Œå–å€¼èŒƒå›´ï¼š0 (AND ANY), 1 (AND ALL), 2 (NOT ANY), 3 (NOT ALL)"
      *  addMemo: "æ˜¯å¦æ˜¾ç¤ºå¤‡æ³¨ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
      *  order: "æ’å…¥é¡ºåºï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ•´æ•°ç±»å‹"
      *  position: "æ’å…¥ä½ç½®ï¼Œæ•´æ•°ç±»å‹ï¼Œå–å€¼èŒƒå›´ï¼š0 (Before Char Defs), 1 (After Char Defs), 2 (Before Example Messages), 3 (After Example Messages), 4 (Top of AN), 5 (Bottom of AN), 6 (@ D), 7 (âš™ï¸ - as a system role message), 8 (ğŸ‘¤ - as a user role message), 9 (ğŸ¤– - as an assistant role message)"
      *  disable: "æ˜¯å¦ç¦ç”¨è¯¥æ¡ç›®ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
      *  excludeRecursion: "æ˜¯å¦åœ¨é€’å½’æ‰«ææ—¶æ’é™¤æ­¤æ¡ç›®ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
      *  preventRecursion: "è§¦å‘æ­¤æ¡ç›®æ—¶æ˜¯å¦é˜»æ­¢é€’å½’æ‰«æï¼Œå¸ƒå°”ç±»å‹(true æˆ– false)"
      *  delayUntilRecursion: "æ˜¯å¦å»¶è¿Ÿåˆ°é€’å½’æ‰«ææ—¶æ‰è§¦å‘ï¼Œå¸ƒå°”ç±»å‹(true æˆ– false)"
      *  probability: "æ¡ç›®è¢«æ’å…¥çš„æ¦‚ç‡ (0-100), æ•´æ•°ç±»å‹"
      *  matchWholeWords: "æ˜¯å¦åŒ¹é…æ•´ä¸ªå•è¯ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false) æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
      *  useProbability: "æ˜¯å¦ä½¿ç”¨æ¦‚ç‡å±æ€§, å¸ƒå°”ç±»å‹ (true æˆ– false)"
      *  depth: "æ·±åº¦, å½“ position ä¸ºç‰¹å®šå€¼æ—¶ä½¿ç”¨, æ•´æ•°ç±»å‹"
      *  group: "åˆ†ç»„åç§°ï¼Œå­—ç¬¦ä¸²ç±»å‹"
      *  groupOverride: "æ˜¯å¦è¦†ç›–åˆ†ç»„ï¼Œå¸ƒå°”ç±»å‹(true æˆ– false)"
      *  groupWeight: "åˆ†ç»„æƒé‡ï¼Œæ•´æ•°ç±»å‹"
      *  scanDepth: "æ‰«ææ·±åº¦ï¼Œæ•´æ•°ç±»å‹æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
      *  caseSensitive: "æ˜¯å¦åŒºåˆ†å¤§å°å†™ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false) æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
      *  useGroupScoring: "æ˜¯å¦ä½¿ç”¨åˆ†ç»„è¯„åˆ†ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false) æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
      *  automationId: "è‡ªåŠ¨åŒ–çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå­—ç¬¦ä¸²ç±»å‹"
      *  role: "è§’è‰²æ¶ˆæ¯ï¼Œæ•´æ•°ç±»å‹(0:User, 1:System, 2:Assistant) æˆ– null"
      *  sticky: "æ˜¯å¦å¸¸é©»ï¼Œæ•´æ•°ç±»å‹ï¼Œå–å€¼èŒƒå›´ï¼š0(å¦), 1(æ˜¯), 2(ç›´åˆ°ä¸Šä¸‹æ–‡æ»¡)"
      *  cooldown: "å†·å´æ—¶é—´ï¼Œæ•´æ•°ç±»å‹"
      *  delay: "å»¶è¿Ÿæ—¶é—´ï¼Œæ•´æ•°ç±»å‹"
      *  displayIndex: "æ˜¾ç¤ºç´¢å¼•ï¼Œæ•´æ•°ç±»å‹"
      */
    function createEntry(info, order, depth) {
      return {
        "uid": info.uid,                 // "uid": "å”¯ä¸€ IDï¼Œæ•´æ•°ç±»å‹"
        "key": info.key,                 // "key": "è§¦å‘æ¡ç›®çš„å…³é”®å­—åˆ—è¡¨ï¼Œæ”¯æŒæ–‡æœ¬å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œå­—ç¬¦ä¸²æ•°ç»„"
        "keysecondary": info.keysecondary, // "keysecondary": "å¯é€‰çš„æ¬¡è¦å…³é”®å­—åˆ—è¡¨ï¼Œå­—ç¬¦ä¸²æ•°ç»„"
        "comment": info.comment,           // "comment": "æ¡ç›®çš„æ³¨é‡Šæˆ–æ ‡é¢˜ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "content": info.content,           // "content": "æ’å…¥åˆ°æç¤ºè¯çš„æ–‡æœ¬å†…å®¹ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "constant": false,               // "constant": "æ˜¯å¦å¸¸é©»ï¼Œå¦‚æœä¸º true åˆ™å§‹ç»ˆæ’å…¥ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "vectorized": false,             // "vectorized": "æ˜¯å¦ä»…é€šè¿‡å‘é‡åŒ¹é…æ¿€æ´»ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "selective": true,              // "selective": "æ˜¯å¦å¯ç”¨é€‰æ‹©æ€§è¿‡æ»¤,éœ€è¦åŒæ—¶æ»¡è¶³ key å’Œ keysecondary æ‰èƒ½è§¦å‘ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "selectiveLogic": 0,             // "selectiveLogic": "é€‰æ‹©æ€§é€»è¾‘ï¼Œæ•´æ•°ç±»å‹ï¼Œå–å€¼èŒƒå›´ï¼š0 (AND ANY), 1 (AND ALL), 2 (NOT ANY), 3 (NOT ALL)"
        "addMemo": true,                // "addMemo": "æ˜¯å¦æ˜¾ç¤ºå¤‡æ³¨ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "order": order,                   // "order": "æ’å…¥é¡ºåºï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ•´æ•°ç±»å‹"
        "position": 1,                   // "position": "æ’å…¥ä½ç½®ï¼Œæ•´æ•°ç±»å‹ï¼Œå–å€¼èŒƒå›´ï¼š0 (Before Char Defs), 1 (After Char Defs), 2 (Before Example Messages), 3 (After Example Messages), 4 (Top of AN), 5 (Bottom of AN), 6 (@ D), 7 (âš™ï¸ - as a system role message), 8 (ğŸ‘¤ - as a user role message), 9 (ğŸ¤– - as an assistant role message)"
        "disable": false,                // "disable": "æ˜¯å¦ç¦ç”¨è¯¥æ¡ç›®ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "excludeRecursion": false,        // "excludeRecursion": "æ˜¯å¦åœ¨é€’å½’æ‰«ææ—¶æ’é™¤æ­¤æ¡ç›®ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "preventRecursion": true,         // "preventRecursion": "è§¦å‘æ­¤æ¡ç›®æ—¶æ˜¯å¦é˜»æ­¢é€’å½’æ‰«æï¼Œå¸ƒå°”ç±»å‹(true æˆ– false)"
        "delayUntilRecursion": false,     // "delayUntilRecursion": "æ˜¯å¦å»¶è¿Ÿåˆ°é€’å½’æ‰«ææ—¶æ‰è§¦å‘ï¼Œå¸ƒå°”ç±»å‹(true æˆ– false)"
        "probability": 100,              // "probability": "æ¡ç›®è¢«æ’å…¥çš„æ¦‚ç‡ (0-100), æ•´æ•°ç±»å‹"
        "matchWholeWords": null,              //  "matchWholeWords": "æ˜¯å¦åŒ¹é…æ•´ä¸ªå•è¯ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false) æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
        "useProbability": true,         //   "useProbability": "æ˜¯å¦ä½¿ç”¨æ¦‚ç‡å±æ€§, å¸ƒå°”ç±»å‹ (true æˆ– false)"
        "depth": depth,                   // "depth": "æ·±åº¦, å½“ position ä¸ºç‰¹å®šå€¼æ—¶ä½¿ç”¨, æ•´æ•°ç±»å‹"
        "group": "",                      // "group": "åˆ†ç»„åç§°ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "groupOverride": false,          // "groupOverride": "æ˜¯å¦è¦†ç›–åˆ†ç»„ï¼Œå¸ƒå°”ç±»å‹(true æˆ– false)"
        "groupWeight": 100,              // "groupWeight": "åˆ†ç»„æƒé‡ï¼Œæ•´æ•°ç±»å‹"
        "scanDepth": null,              // "scanDepth": "æ‰«ææ·±åº¦ï¼Œæ•´æ•°ç±»å‹æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
        "caseSensitive": null,         // "caseSensitive": "æ˜¯å¦åŒºåˆ†å¤§å°å†™ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false) æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
        "useGroupScoring": null,          // "useGroupScoring": "æ˜¯å¦ä½¿ç”¨åˆ†ç»„è¯„åˆ†ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false) æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
        "automationId": "",              // "automationId": "è‡ªåŠ¨åŒ–çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "role": null,                  // "role": "è§’è‰²æ¶ˆæ¯ï¼Œæ•´æ•°ç±»å‹(0:User, 1:System, 2:Assistant) æˆ– null"
        "sticky": 0,                      // "sticky": "æ˜¯å¦å¸¸é©»ï¼Œæ•´æ•°ç±»å‹ï¼Œå–å€¼èŒƒå›´ï¼š0(å¦), 1(æ˜¯), 2(ç›´åˆ°ä¸Šä¸‹æ–‡æ»¡)"
        "cooldown": 0,                  // "cooldown": "å†·å´æ—¶é—´ï¼Œæ•´æ•°ç±»å‹"
        "delay": 0,                       // "delay": "å»¶è¿Ÿæ—¶é—´ï¼Œæ•´æ•°ç±»å‹"
        "displayIndex": info.displayIndex  // "displayIndex": "æ˜¾ç¤ºç´¢å¼•ï¼Œæ•´æ•°ç±»å‹"
      };
    }

    /**
     * æå–æ–‡ä»¶ä¿¡æ¯
     * @param {string} content - æ–‡ä»¶å†…å®¹
     * @param {string} fileName - æ–‡ä»¶å
     * @param {string} filePath - æ–‡ä»¶è·¯å¾„
     * @param {number} uid - å”¯ä¸€ ID
     * @param {number} displayIndex - æ˜¾ç¤ºç´¢å¼•
     * @param {number} fileSize - æ–‡ä»¶å¤§å°
     * @returns {object} - åŒ…å« uid, key, keysecondary, comment, content, displayIndex, fileSize çš„ä¿¡æ¯å¯¹è±¡
     *
     */
    function extractInfo(content, fileName, filePath, uid, displayIndex, fileSize) {
      const folderParts = filePath.split('/');
      const folderName = folderParts.slice(-2)[0]; // è·å–å€’æ•°ç¬¬äºŒä¸ªç›®å½•å
      const title = fileName.split('.').slice(0, -1).join('.');
      return {
        "uid": uid,                     // "uid": "å”¯ä¸€ IDï¼Œæ•´æ•°ç±»å‹"
        "key": [folderName],            // "key": "è§¦å‘æ¡ç›®çš„å…³é”®å­—åˆ—è¡¨ï¼Œæ”¯æŒæ–‡æœ¬å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œå­—ç¬¦ä¸²æ•°ç»„"
        "keysecondary": [title],        // "keysecondary": "å¯é€‰çš„æ¬¡è¦å…³é”®å­—åˆ—è¡¨ï¼Œå­—ç¬¦ä¸²æ•°ç»„"
        "comment": title,               // "comment": "æ¡ç›®çš„æ³¨é‡Šæˆ–æ ‡é¢˜ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "content": content,             // "content": "æ’å…¥åˆ°æç¤ºè¯çš„æ–‡æœ¬å†…å®¹ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "displayIndex": displayIndex,    //  "displayIndex": "æ˜¾ç¤ºç´¢å¼•ï¼Œæ•´æ•°ç±»å‹"
        "fileSize": fileSize             //   ç”¨äºè®¡ç®—æ·±åº¦
      };
    }

    /**
     * åˆ›å»ºä¸€ä¸ªåˆ†éš”ç¬¦æ¡ç›®
     * @param {number} uid - å”¯ä¸€ ID
     * @param {number} displayIndex - æ˜¾ç¤ºç´¢å¼•
     * @param {string} text - åˆ†éš”ç¬¦æ–‡æœ¬
      * @param {array} fileList - æ–‡ä»¶åˆ—è¡¨
     * @param {boolean} isStart - æ˜¯å¦ä¸ºå¼€å§‹åˆ†éš”ç¬¦
     * @param {number} startOrder - å¼€å§‹é¡ºåº
     * @returns {object} - åˆ†éš”ç¬¦æ¡ç›®å¯¹è±¡
     */
    function createDividerEntry(uid, displayIndex, text, fileList = null, isStart = false, startOrder = 0) {
      let folderName = text.split('/').pop();
      let content = "";
      let position = 0;
      let order = 0;
      if (isStart) {
        if (fileList) {
          let fileListStr = fileList.join(",");
          content = `<${folderName}-åˆ—è¡¨>\n {{random: ${fileListStr}}}\n</${folderName}-åˆ—è¡¨>`;
        } else {
          content = `<${folderName}-åˆ—è¡¨>\n {{random: }}\n</${folderName}-åˆ—è¡¨>`;

        }
        position = 0;
        order = startOrder;
      } else {
        position = 1;
        order = startOrder + 2;
      }
      return {
        "uid": uid,                     // "uid": "å”¯ä¸€ IDï¼Œæ•´æ•°ç±»å‹"
        "key": [folderName],           // "key": "è§¦å‘æ¡ç›®çš„å…³é”®å­—åˆ—è¡¨ï¼Œæ”¯æŒæ–‡æœ¬å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œå­—ç¬¦ä¸²æ•°ç»„"
        "keysecondary": [],           // "keysecondary": "å¯é€‰çš„æ¬¡è¦å…³é”®å­—åˆ—è¡¨ï¼Œå­—ç¬¦ä¸²æ•°ç»„"
        "comment": isStart ? `--å§‹ ${folderName}--` : `--${folderName} ç»ˆ--`, // "comment": "æ¡ç›®çš„æ³¨é‡Šæˆ–æ ‡é¢˜ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "content": content,             // "content": "æ’å…¥åˆ°æç¤ºè¯çš„æ–‡æœ¬å†…å®¹ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "constant": true,             // "constant": "æ˜¯å¦å¸¸é©»ï¼Œå¦‚æœä¸º true åˆ™å§‹ç»ˆæ’å…¥ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "vectorized": false,          // "vectorized": "æ˜¯å¦ä»…é€šè¿‡å‘é‡åŒ¹é…æ¿€æ´»ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "selective": true,            // "selective": "æ˜¯å¦å¯ç”¨é€‰æ‹©æ€§è¿‡æ»¤,éœ€è¦åŒæ—¶æ»¡è¶³ key å’Œ keysecondary æ‰èƒ½è§¦å‘ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "selectiveLogic": 0,            // "selectiveLogic": "é€‰æ‹©æ€§é€»è¾‘ï¼Œæ•´æ•°ç±»å‹ï¼Œå–å€¼èŒƒå›´ï¼š0 (AND ANY), 1 (AND ALL), 2 (NOT ANY), 3 (NOT ALL)"
        "addMemo": true,               // "addMemo": "æ˜¯å¦æ˜¾ç¤ºå¤‡æ³¨ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "order": order,                  // "order": "æ’å…¥é¡ºåºï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ•´æ•°ç±»å‹"
        "position": position,           // "position": "æ’å…¥ä½ç½®ï¼Œæ•´æ•°ç±»å‹ï¼Œå–å€¼èŒƒå›´ï¼š0 (Before Char Defs), 1 (After Char Defs), 2 (Before Example Messages), 3 (After Example Messages), 4 (Top of AN), 5 (Bottom of AN), 6 (@ D), 7 (âš™ï¸ - as a system role message), 8 (ğŸ‘¤ - as a user role message), 9 (ğŸ¤– - as an assistant role message)"
        "disable": false,              // "disable": "æ˜¯å¦ç¦ç”¨è¯¥æ¡ç›®ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "excludeRecursion": false,    // "excludeRecursion": "æ˜¯å¦åœ¨é€’å½’æ‰«ææ—¶æ’é™¤æ­¤æ¡ç›®ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false)"
        "preventRecursion": false,  // "preventRecursion": "è§¦å‘æ­¤æ¡ç›®æ—¶æ˜¯å¦é˜»æ­¢é€’å½’æ‰«æï¼Œå¸ƒå°”ç±»å‹(true æˆ– false)"
        "delayUntilRecursion": false,    // "delayUntilRecursion": "æ˜¯å¦å»¶è¿Ÿåˆ°é€’å½’æ‰«ææ—¶æ‰è§¦å‘ï¼Œå¸ƒå°”ç±»å‹(true æˆ– false)"
        "probability": 100,             // "probability": "æ¡ç›®è¢«æ’å…¥çš„æ¦‚ç‡ (0-100), æ•´æ•°ç±»å‹"
        "matchWholeWords": null,        //  "matchWholeWords": "æ˜¯å¦åŒ¹é…æ•´ä¸ªå•è¯ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false) æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
        "useProbability": true,         //   "useProbability": "æ˜¯å¦ä½¿ç”¨æ¦‚ç‡å±æ€§, å¸ƒå°”ç±»å‹ (true æˆ– false)"
        "depth": 4,                      // "depth": "æ·±åº¦, å½“ position ä¸ºç‰¹å®šå€¼æ—¶ä½¿ç”¨, æ•´æ•°ç±»å‹"
        "group": "",                    // "group": "åˆ†ç»„åç§°ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "groupOverride": false,           // "groupOverride": "æ˜¯å¦è¦†ç›–åˆ†ç»„ï¼Œå¸ƒå°”ç±»å‹(true æˆ– false)"
        "groupWeight": 100,              // "groupWeight": "åˆ†ç»„æƒé‡ï¼Œæ•´æ•°ç±»å‹"
        "scanDepth": null,                // "scanDepth": "æ‰«ææ·±åº¦ï¼Œæ•´æ•°ç±»å‹æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
        "caseSensitive": null,           // "caseSensitive": "æ˜¯å¦åŒºåˆ†å¤§å°å†™ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false) æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
        "useGroupScoring": null,          // "useGroupScoring": "æ˜¯å¦ä½¿ç”¨åˆ†ç»„è¯„åˆ†ï¼Œå¸ƒå°”ç±»å‹ (true æˆ– false) æˆ– nullï¼Œnull è¡¨ç¤ºä½¿ç”¨å…¨å±€è®¾ç½®"
        "automationId": "",                // "automationId": "è‡ªåŠ¨åŒ–çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå­—ç¬¦ä¸²ç±»å‹"
        "role": 1,                      // "role": "è§’è‰²æ¶ˆæ¯ï¼Œæ•´æ•°ç±»å‹(0:User, 1:System, 2:Assistant) æˆ– null"
        "sticky": 0,                  // "sticky": "æ˜¯å¦å¸¸é©»ï¼Œæ•´æ•°ç±»å‹ï¼Œå–å€¼èŒƒå›´ï¼š0(å¦), 1(æ˜¯), 2(ç›´åˆ°ä¸Šä¸‹æ–‡æ»¡)"
        "cooldown": 0,                // "cooldown": "å†·å´æ—¶é—´ï¼Œæ•´æ•°ç±»å‹"
        "delay": 0,                     // "delay": "å»¶è¿Ÿæ—¶é—´ï¼Œæ•´æ•°ç±»å‹"
        "displayIndex": displayIndex    // "displayIndex": "æ˜¾ç¤ºç´¢å¼•ï¼Œæ•´æ•°ç±»å‹"
      };
    }

    /**
     * ç”Ÿæˆ Worldbook JSON æ•°æ®
     */
    async function generateWorldbook() {
      const fileInput = document.getElementById('fileInput');
      const files = Array.from(fileInput.files).sort((a, b) => a.webkitRelativePath.localeCompare(b.webkitRelativePath));
      if (files.length === 0) {
        alert("è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼");
        return;
      }

      const firstFile = files[0];
      const uploadFolderName = firstFile.webkitRelativePath.split('/')[0];
      let entries = {};
      let uidCounter = 0;
      let displayIndex = 0;
      let folder_order = 99;
      let currentFolder = "";

      const now = new Date();
      const formattedDate = now.toLocaleString();
      const metadataContent = `{{//
---
ç”Ÿæˆæ—¶é—´: ${formattedDate}
---
ä¸–ç•Œä¹¦æè¿°ï¼š
æ ‡ç­¾ï¼š
---
é…ç½®ä¿¡æ¯ï¼š
 - åŒºåˆ†å¤§å°å†™:  å¦
---
å…è´£å£°æ˜ï¼š
æœ¬ä¸–ç•Œä¹¦ç”±åŠè‡ªåŠ¨åŒ–å·¥å…·ç”Ÿæˆï¼Œå¯èƒ½åŒ…å«ä¸å‡†ç¡®æˆ–ä¸å®Œå–„çš„ä¿¡æ¯ã€‚
ç”¨æˆ·åº”è‡ªè¡Œåˆ¤æ–­ä¿¡æ¯çš„é€‚ç”¨æ€§ï¼Œå¹¶æ‰¿æ‹…ä½¿ç”¨æœ¬ä¸–ç•Œä¹¦çš„é£é™©ã€‚
æœ¬ä¸–ç•Œä¹¦ä¸­çš„å†…å®¹ï¼Œä¸æ„æˆä»»ä½•å½¢å¼çš„å»ºè®®æˆ–ä¿è¯ã€‚
æœ¬å·¥å…·ä¸ä¿è¯ç”Ÿæˆçš„æ–‡æœ¬å®Œå…¨ç¬¦åˆé¢„æœŸï¼Œä¹Ÿä¸å¯¹ç”±æ­¤äº§ç”Ÿçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥æŸå¤±è´Ÿè´£ã€‚
---
å†…å®¹æ¥æºï¼šæœ¬ä¸–ç•Œä¹¦çš„å†…å®¹ç”±ç”¨æˆ·æä¾›çš„æ–‡æœ¬æ–‡ä»¶ç”Ÿæˆï¼Œæœ¬å·¥å…·ä¸å¯¹è¿™äº›æ–‡ä»¶çš„å†…å®¹å’Œæ¥æºçš„åˆæ³•æ€§è´Ÿè´£ã€‚
---
ç‰ˆæƒå£°æ˜ï¼š
æœ¬ä¸–ç•Œä¹¦é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯ã€‚
(Creative Commons Attribution-ShareAlike 4.0 International License)
æŸ¥çœ‹è®¸å¯è¯å‰¯æœ¬è¯·è®¿é—®ï¼šhttps://creativecommons.org/licenses/by-sa/4.0/
---
ä½œè€…ï¼š 
---
}}`;

      entries[uidCounter] = {
        "uid": uidCounter,
        "key": [],
        "keysecondary": [],
        "comment": "ã€è¯´æ˜ã€‘",
        "content": metadataContent,
        "constant": true,
        "vectorized": false,
        "selective": false,
        "selectiveLogic": 0,
        "addMemo": true,
        "order": 98,
        "position": 0,
        "disable": false,
        "excludeRecursion": false,
        "preventRecursion": false,
        "delayUntilRecursion": false,
        "probability": 100,
        "matchWholeWords": null,
        "useProbability": true,
        "depth": 4,
        "group": "",
        "groupOverride": false,
        "groupWeight": 100,
        "scanDepth": null,
        "caseSensitive": null,
        "useGroupScoring": null,
        "automationId": "",
        "role": 1,
        "sticky": 0,
        "cooldown": 0,
        "delay": 0,
        "displayIndex": displayIndex
      };
      uidCounter++;
      displayIndex++;

      for (const file of files) {
        const filePath = file.webkitRelativePath;
        const folderName = filePath.split('/').slice(0, -1).join('/');
        const fileName = file.name;
        const fileSize = file.size;

        if (currentFolder !== folderName) {
          if (currentFolder !== "") {
            entries[uidCounter] = createDividerEntry(uidCounter, displayIndex, `End of ${currentFolder}`, null, false, folder_order);
            uidCounter++;
            displayIndex++;
          }

          const currentFolderFiles = files
            .filter(f => f.webkitRelativePath.startsWith(folderName + '/'))
            .map(f => f.name.split('.').slice(0, -1).join(''));


          entries[uidCounter] = createDividerEntry(uidCounter, displayIndex, `${folderName}`, currentFolderFiles, true, folder_order);
          uidCounter++;
          displayIndex++;
          currentFolder = folderName;
          folder_order += 10;
        }

        const content = await file.text();
        const info = extractInfo(content, fileName, filePath, uidCounter, displayIndex, fileSize);
        if (info) {
          let depth = 4;
          if (info["fileSize"] <= 512) {
            depth = 4;
          } else if (info["fileSize"] <= 1024) {
            depth = 5;
          } else if (info["fileSize"] <= 1536) {
            depth = 6;
          } else if (info["fileSize"] <= 2048) {
            depth = 7;
          } else {
            depth = 8;
          }

          let order = folder_order + 1;
          entries[uidCounter] = createEntry(info, order, depth);
          uidCounter++;
          displayIndex++;
        }
      }

      if (currentFolder !== "") {
        entries[uidCounter] = createDividerEntry(uidCounter, displayIndex, `End of ${currentFolder}`, null, false, folder_order);
      }

      const worldbook = { "entries": entries };
      const output = JSON.stringify(worldbook, null, 2);
      document.getElementById('output').textContent = output;

      const blob = new Blob([output], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ã€ŒIxiaã€-ä¸–ç•Œä¹¦ - ${uploadFolderName}.json`;
      a.textContent = `ä¸‹è½½ ã€ŒIxiaã€-ä¸–ç•Œä¹¦ - ${uploadFolderName}.json`;
      a.className = 'download-link';
      document.body.appendChild(a);
    }
  </script>
</body>

</html>